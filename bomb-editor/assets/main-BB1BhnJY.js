(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const d of n)if(d.type==="childList")for(const a of d.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&t(a)}).observe(document,{childList:!0,subtree:!0});function r(n){const d={};return n.integrity&&(d.integrity=n.integrity),n.referrerPolicy&&(d.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?d.credentials="include":n.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function t(n){if(n.ep)return;n.ep=!0;const d=r(n);fetch(n.href,d)}})();const b={file_name:"level.json"};class p{static load(){const e=document.createElement("input");e.type="file",e.accept=".json",e.addEventListener("change",()=>{const r=new FileReader;r.addEventListener("load",()=>{try{const t=JSON.parse(r.result);if(t.rules===void 0||t.map===void 0)confirm("無法加載關卡 (錯誤的格式)");else if(t.file_name=e.files[0].name,t.rules.player_speed!==void 0&&this.set_property("player_speed",t.rules.player_speed),t.rules.player_bombs!==void 0&&this.set_property("player_bombs",t.rules.player_bombs),t.rules.bomb_countdown!==void 0&&this.set_property("bomb_countdown",t.rules.bomb_countdown),t.rules.bomb_explode_range!==void 0&&this.set_property("bomb_explode_range",t.rules.bomb_explode_range),t.map.width!==void 0&&this.set_property("map_width",t.map.width),t.map.height!==void 0&&this.set_property("map_height",t.map.height),o.clear(),t.map.tiles!==void 0)for(const n of t.map.tiles)o.set_tile(n.type,n.x,n.y)}catch{confirm("無法加載關卡 (無法解析 JSON)")}},{once:!0}),r.readAsText(e.files[0])}),e.click()}static save(){const e=URL.createObjectURL(new Blob([JSON.stringify({rules:{player_speed:this.get_property("player_speed"),player_bombs:this.get_property("player_bombs"),bomb_countdown:this.get_property("bomb_countdown"),bomb_explode_range:this.get_property("bomb_explode_range")},map:{width:this.get_property("map_width"),height:this.get_property("map_height"),tiles:o.export_tiles()}},void 0,2)],{type:"application/json"})),r=document.createElement("a");r.href=e,r.download=b.file_name,r.click()}static reset_all_properties(){for(const e of Object.keys(c))this.set_property(e,c[e].default)}static get_property(e){if(c[e]===void 0)throw new Error(`Unknown property "${e}"!`);return c[e].value}static set_property(e,r){if(c[e]===void 0)throw new Error(`Unknown property "${e}"!`);const t=c[e];t.value=Math.max(t.min,Math.min(t.max,r)),t.input.value=t.value.toString(),(e==="map_width"||e==="map_height")&&o.resize(c.map_width.value,c.map_height.value)}}const c={player_speed:{input:document.getElementById("property-player-speed"),min:1,max:64,default:5,value:5},player_bombs:{input:document.getElementById("property-player-bombs"),min:1,max:64,default:2,value:2},bomb_countdown:{input:document.getElementById("property-bomb-countdown"),min:1,max:1024,default:150,value:150},bomb_explode_range:{input:document.getElementById("property-bomb-explode-range"),min:1,max:1024,default:125,value:125},map_width:{input:document.getElementById("property-map-width"),min:1,max:64,default:9,value:9},map_height:{input:document.getElementById("property-map-height"),min:1,max:64,default:5,value:5}};for(const s of Object.keys(c)){const e=c[s],r=e.input;r.value=e.default.toString(),r.addEventListener("change",()=>{/^\d+$/.test(r.value)?p.set_property(s,parseInt(r.value)):r.value=r.value.toString()}),r.addEventListener("keydown",t=>{t.key==="ArrowUp"?p.set_property(s,e.value+1):t.key==="ArrowDown"&&p.set_property(s,e.value-1)})}const v="/bomb-editor/assets/tile_ground-CqO3eniT.png",x="/bomb-editor/assets/tile_player-BC0wgStG.png",E="/bomb-editor/assets/tile_barrel-CiYyJdmA.png",z="/bomb-editor/assets/tile_rock-BbsIlq2a.png",i={width:0,height:0,tiles:[],tile_render_size:0,render_offset_x:0,render_offset_y:0};class o{static get width(){return i.width}static get height(){return i.height}static get tile_render_size(){return i.tile_render_size}static get render_offset_x(){return i.render_offset_x}static get render_offset_y(){return i.render_offset_y}static resize(e,r){const t=this.width,n=this.height,d=structuredClone(i.tiles);i.width=e,i.height=r,i.tiles=new Array(e*r).fill("empty");for(let a=0;a<e;a++)for(let u=0;u<r;u++)a<t&&u<n&&(i.tiles[a+u*e]=d[a+u*t])}static clear(){i.tiles=new Array(i.width*i.height).fill("empty")}static get_tile(e,r){const t=e+r*this.width;if(t<0||t>i.tiles.length)throw new Error(`Tile position ${e}, ${r} is out of bound! (${this.width}, ${this.height})`);return i.tiles[t]}static set_tile(e,r,t){const n=r+t*this.width;if(_[e]===void 0&&e!=="empty")throw new Error(`Tile type "${e}" not found! (${r}, ${t})`);if(n<0||n>i.tiles.length)throw new Error(`Tile position ${r}, ${t} is out of bound! (${this.width}, ${this.height})`);i.tiles[n]=e}static count_tile(e){let r=0;for(const t of i.tiles)t===e&&r++;return r}static export_tiles(){const e=[];for(let r=0;r<i.width;r++)for(let t=0;t<i.height;t++){const n=r+t*this.width;i.tiles[n]!=="empty"&&e.push({type:i.tiles[n],x:r,y:t})}return e}static render(e,r){e.width>e.height?i.tile_render_size=e.width/(i.width+1):i.tile_render_size=e.height/(i.height+1),i.tile_render_size*i.width>e.width?i.tile_render_size=e.width/(i.width+1):i.tile_render_size*i.height>e.height&&(i.tile_render_size=e.height/(i.height+1)),i.render_offset_x=e.width/2-i.width*i.tile_render_size/2,i.render_offset_y=e.height/2-i.height*i.tile_render_size/2;for(let t=0;t<i.width;t++)for(let n=0;n<i.height;n++){r.drawImage(_.ground.image,i.render_offset_x+t*i.tile_render_size,i.render_offset_y+(n+.15)*i.tile_render_size,i.tile_render_size,i.tile_render_size);const d=t+n*this.width;i.tiles[d]!=="empty"&&r.drawImage(_[i.tiles[d]].image,i.render_offset_x+t*i.tile_render_size,i.render_offset_y+n*i.tile_render_size,i.tile_render_size,i.tile_render_size)}for(let t=0;t<i.width;t++)for(let n=0;n<i.height;n++){const d=t+n*this.width;i.tiles[d]==="player"&&(r.fillStyle="rgba(255,0,0,0.15)",r.arc(i.render_offset_x+(t*i.tile_render_size+i.tile_render_size/2),i.render_offset_y+(n*i.tile_render_size+i.tile_render_size/2),i.tile_render_size/64*p.get_property("bomb_explode_range"),0,2*Math.PI),r.fill(),r.beginPath())}}}o.resize(9,5);async function h(s){return new Promise(e=>{const r=new Image;r.addEventListener("load",()=>e(r),{once:!0}),r.src=s})}const _={ground:{image:await h(v),max:0},player:{image:await h(x),max:4},barrel:{image:await h(E),max:1/0},rock:{image:await h(z),max:1/0}},l={mouse_x:0,mouse_y:0,mouse_pressed:!1,current_tile:"empty",mode:"place"};let g=document.getElementById("canvas");g.addEventListener("mousemove",s=>{l.mouse_x=s.offsetX*1.5,l.mouse_y=s.offsetY*1.5,y.update()});g.addEventListener("mousedown",()=>{const s=Math.round((l.mouse_x-o.tile_render_size/2-o.render_offset_x)/o.tile_render_size),e=Math.round((l.mouse_y-o.tile_render_size/2-o.render_offset_y)/o.tile_render_size);l.mouse_pressed=!0,s>=0&&s<o.width&&e>=0&&e<o.height&&(o.get_tile(s,e)===l.current_tile?l.mode="destory":l.mode="place",y.update())});g.addEventListener("mouseup",()=>{l.mouse_pressed=!1,l.mode="place"});class y{static update(){if(l.mouse_pressed){const e=Math.round((l.mouse_x-o.tile_render_size/2-o.render_offset_x)/o.tile_render_size),r=Math.round((l.mouse_y-o.tile_render_size/2-o.render_offset_y)/o.tile_render_size);e>=0&&e<o.width&&r>=0&&r<o.height&&(l.mode==="place"?(_[l.current_tile].max===1/0||o.count_tile(l.current_tile)<_[l.current_tile].max)&&o.set_tile(l.current_tile,e,r):l.mode==="destory"&&o.set_tile("empty",e,r))}}static render(e,r){const t=Math.round((l.mouse_x-o.tile_render_size/2-o.render_offset_x)/o.tile_render_size),n=Math.round((l.mouse_y-o.tile_render_size/2-o.render_offset_y)/o.tile_render_size);t>=0&&t<o.width&&n>=0&&n<o.height&&(r.filter="opacity(0.5)",r.drawImage(_[l.current_tile].image,o.render_offset_x+t*o.tile_render_size,o.render_offset_y+n*o.tile_render_size,o.tile_render_size,o.tile_render_size),r.filter="none")}}const L=document.getElementById("tile_types");for(const s of Object.keys(_))if(_[s].max>0){const e=document.createElement("div");e.classList.add("menu-item");const r=document.createElement("img");r.src=_[s].image.src,r.style.width="2rem",e.append(r),L.append(e),l.current_tile==="empty"&&(l.current_tile=s),e.addEventListener("click",()=>l.current_tile=s)}const m=document.getElementById("canvas"),f=m.getContext("2d");function w(){const s=m.getBoundingClientRect();m.width=s.width*1.5,m.height=s.height*1.5}w();window.addEventListener("resize",w);setInterval(()=>{f.clearRect(0,0,m.width,m.height),o.render(m,f),y.render(m,f)},1e3/30);document.getElementById("button-load-level").addEventListener("click",()=>p.load());document.getElementById("button-save-level").addEventListener("click",()=>p.save());document.getElementById("button-save-as-image").addEventListener("click",()=>{const s=document.createElement("canvas"),e=s.getContext("2d"),r=512/(o.width-1);s.width=512,s.height=o.height*r,o.render(s,e),m.toBlob(t=>{const n=document.createElement("a");n.href=URL.createObjectURL(t),n.download="level.png",n.click()})});document.getElementById("button-reset-map").addEventListener("click",()=>{confirm("確認要重置地圖嗎？")&&o.clear()});document.getElementById("button-reset-properties").addEventListener("click",()=>{confirm("確認要重置關卡參數嗎？")&&p.reset_all_properties()});document.getElementById("button-export-tileset").addEventListener("click",()=>{const s=document.createElement("canvas"),e=s.getContext("2d"),r=[_.player.image,_.barrel.image,_.rock.image];s.width=64*5,s.height=Math.ceil(r.length/5)*64;let t=0,n=0;for(const d of r)e.drawImage(d,t*64,n*64,64,64),t++,t>=5&&(t=0,n++);console.log(!0),s.toBlob(d=>{const a=document.createElement("a");a.href=URL.createObjectURL(d),a.download="tileset.png",a.click()})});
